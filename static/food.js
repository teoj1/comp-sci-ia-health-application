const DAILY_MACROS = {
    calories: 1800,
    protein: 75,
    carbs: 350,
    fat: 50
};

let macroTotals = {
    calories: 0,
    protein: 0,
    carbs: 0,
    fat: 0
};


// handleImageUpload placeholder - shows preview if #mealImagePreview exists
function handleImageUpload(event) {
    const file = event?.target?.files?.[0];
    if (!file) return;
    const preview = document.getElementById('mealImagePreview');
    if (preview) {
        const reader = new FileReader();
        reader.onload = () => { preview.src = reader.result; };
        reader.readAsDataURL(file);
    }
}


document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('generateMealsBtn').addEventListener('click', loadMeals);
    renderMealHistory();

    document.getElementById('viewMealHistoryBtn').addEventListener('click', renderMealHistory);

    // removed programmatic hidden file input (we use #mealImageInput present in template)
});


function loadMeals() {
    fetch('/recommend?user_id=' + window.currentUserId)
        .then(response => response.json())
        .then(data => displayMeals(data));
}


function displayMeals(meals) {
  const mealSections = document.getElementById('mealSections');
  mealSections.innerHTML = ''; // Clear previous output

  ['breakfast', 'lunch', 'dinner', 'snacks'].forEach(type => {
    if (Array.isArray(meals[type]) && meals[type].length > 0) {
      const macroTarget = meals[type][0].macro_target;

      let html = `<h2>${type.charAt(0).toUpperCase() + type.slice(1)}</h2>
        <p><b>Target for this meal:</b> 
        ${macroTarget.calories} kcal, 
        ${macroTarget.protein}g protein, 
        ${macroTarget.carbs}g carbs, 
        ${macroTarget.fat}g fat</p>`;

        html += meals[type].map((meal, idx) => `
            <div class="meal-card" data-type="${type}" data-idx="${idx}">
            <h3>${meal.description}</h3>
            <p><strong>Ingredients:</strong> ${meal.ingredients && meal.ingredients !== "Unknown" ? meal.ingredients : 'Ingredients not found'}</p>
            <p>Calories: ${meal.nutrition.calories} kcal</p>
            <p>Protein: ${meal.nutrition.protein}g</p>
            <p>Carbs: ${meal.nutrition.carbs}g</p>
            <p>Fat: ${meal.nutrition.fat}g</p>
            <button class="eat-meal-btn">I've eaten this meal</button>
            </div>
        `).join('');

        const section = document.createElement('div');
        section.innerHTML = html;
        mealSections.appendChild(section);
    }
  });

  // Add event listeners for the buttons after inserting elements
  document.querySelectorAll('.eat-meal-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const card = btn.closest('.meal-card');
      const type = card.getAttribute('data-type');
      const idx = parseInt(card.getAttribute('data-idx'));
      const meal = meals[type][idx];
      confirmMeal(meal);
    });
  });
}

// Add this function to send meal info to backend and update history
// (Function confirmMeal was generated by Github Copilot)
function confirmMeal(meal) {
    const mealData = {
        user_id: window.currentUserId,
        date: new Date().toISOString().slice(0, 10),
        calories: meal.nutrition.calories,
        protein: meal.nutrition.protein,
        carbs: meal.nutrition.carbs,
        fat: meal.nutrition.fat,
        description: meal.description,
        ingredients: meal.ingredients
    };

    fetch('/record_calories', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(mealData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.message) {
            alert('Meal logged!');
            renderMealHistory();
            // Redirect to dashboard for updated progress bars
            window.location.href = "/dashboard?user_id=" + window.currentUserId;
        } else {
            alert('Error logging meal.');
        }
    });
}

// Updating Meal History UI to allow the user to see their logged meals 
function addMealToHistory(meal) {
    const historyList = document.getElementById('mealHistoryList');
    const entry = document.createElement('tr');
    entry.innerHTML = `
        <td>${meal.date}</td>
        <td>${meal.description}</td>
        <td>${Array.isArray(meal.ingredients) ? meal.ingredients.join(', ') : meal.ingredients}</td>
        <td>${meal.calories} kcal</td>
        <td>${meal.protein}</td>
        <td>${meal.carbs}</td>
        <td>${meal.fat}</td>
    `;
    historyList.prepend(entry);

    // Update macro totals
    macroTotals.calories += Number(meal.calories) || 0;
    macroTotals.protein += Number(meal.protein) || 0;
    macroTotals.carbs += Number(meal.carbs) || 0;
    macroTotals.fat += Number(meal.fat) || 0;
    updateMacroSummary();
}

const mealImageInput = document.getElementById('mealImageInput');
if (mealImageInput) {
    mealImageInput.addEventListener('change', handleImageUpload);
}

const mealForm = document.getElementById('mealForm');
if (mealForm) {
    mealForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const mealData = {
            user_id: window.currentUserId,
            date: new Date().toISOString().slice(0, 10),
            description: document.getElementById('mealName').value,
            ingredients: document.getElementById('mealDescription').value,
            calories: 0,
            protein: 0,
            carbs: 0,
            fat: 0
        };
        fetch('/record_calories', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(mealData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.message) {
                alert('Meal logged!');
                renderMealHistory();
            } else {
                alert('Error logging meal.');
            }
        });
    });
}



function updateMacroSummary() {
    document.getElementById('macroCalories').textContent = `Calories: ${macroTotals.calories} / ${DAILY_MACROS.calories} kcal`;
    document.getElementById('macroProtein').textContent = `Protein: ${macroTotals.protein} / ${DAILY_MACROS.protein}g`;
    document.getElementById('macroCarbs').textContent = `Carbs: ${macroTotals.carbs} / ${DAILY_MACROS.carbs}g`;
    document.getElementById('macroFat').textContent = `Fat: ${macroTotals.fat} / ${DAILY_MACROS.fat}g`;
}

function renderMealHistory() {
    fetch(`/api/meal_history?user_id=${window.currentUserId}`)
        .then(res => res.json())
        .then(meals => {
            const historyList = document.getElementById('mealHistoryList');
            historyList.innerHTML = '';
            let totals = {calories:0, protein:0, carbs:0, fat:0};
            if (Array.isArray(meals)) {
                meals.forEach(meal => {
                    const entry = document.createElement('tr');
                    entry.innerHTML = `
                        <td>${meal.date}</td>
                        <td>${meal.description}</td>
                        <td>${meal.ingredients}</td>
                        <td>${meal.calories} kcal</td>
                        <td>${meal.protein}</td>
                        <td>${meal.carbs}</td>
                        <td>${meal.fat}</td>
                    `;
                    historyList.appendChild(entry);
                    // Sum macros for today only
                    if (meal.date === new Date().toISOString().slice(0,10)) {
                        totals.calories += Number(meal.calories) || 0;
                        totals.protein += Number(meal.protein) || 0;
                        totals.carbs += Number(meal.carbs) || 0;
                        totals.fat += Number(meal.fat) || 0;
                    }
                });
            }
            macroTotals = totals;
            updateMacroSummary();
        });
}

// Replace the existing identify click handler to call predict_and_estimate and allow adding estimated meal
document.getElementById('identifyMealBtn').addEventListener('click', async function() {
    const input = document.getElementById('mealImageInput');
    const file = input && input.files && input.files[0];
    if (!file) {
        alert("Please select an image first.");
        return;
    }

    const mealType = (window.prompt("Meal type (breakfast, lunch, dinner, snack)", "lunch") || "lunch").toLowerCase();
    const formData = new FormData();
    formData.append('image', file);
    formData.append('meal_type', mealType);

    try {
        const res = await fetch('/api/predict_and_estimate', { method: 'POST', body: formData });
        const data = await res.json();
        const resultDiv = document.getElementById('mealIdentificationResult');
        if (!resultDiv) return;

        if (data.predicted_class) {
            let html = `<b>Predicted food:</b> ${data.predicted_class} <br><b>Confidence:</b> ${(data.confidence * 100).toFixed(1)}%<br>`;
            html += `<b>Ingredients:</b> ${data.ingredients || 'Not found'}<br>`;

            if (data.per_100g) {
                html += `<b>Per 100g:</b> ${data.per_100g.calories || 0} kcal, ${data.per_100g.protein || 0}g P, ${data.per_100g.carbs || 0}g C, ${data.per_100g.fat || 0}g F<br>`;
            }
            if (data.estimated_portion) {
                html += `<b>Estimated portion (mult ${data.portion_multiplier}):</b> ${data.estimated_portion.calories} kcal, ${data.estimated_portion.protein}g P, ${data.estimated_portion.carbs}g C, ${data.estimated_portion.fat}g F<br>`;
                html += `<button id="addEstimatedMealBtn" class="button">Add estimated meal to log</button>`;
            } else {
                html += `<span style="color:orange">No estimated nutrition available.</span>`;
            }
            resultDiv.innerHTML = html;

            // wire add-to-log button
            const addBtn = document.getElementById('addEstimatedMealBtn');
            if (addBtn) {
                addBtn.addEventListener('click', async () => {
                    const mealData = {
                        user_id: window.currentUserId,
                        date: new Date().toISOString().slice(0,10),
                        description: data.predicted_class,
                        ingredients: data.ingredients || '',
                        calories: Math.round(data.estimated_portion?.calories || 0),
                        protein: Math.round(data.estimated_portion?.protein || 0),
                        carbs: Math.round(data.estimated_portion?.carbs || 0),
                        fat: Math.round(data.estimated_portion?.fat || 0)
                    };
                    try {
                        const resp = await fetch('/record_calories', {
                            method: 'POST',
                            headers: {'Content-Type':'application/json'},
                            body: JSON.stringify(mealData)
                        });
                        const j = await resp.json();
                        if (j.message) {
                            alert('Estimated meal logged.');
                            renderMealHistory();
                            // update summary immediately
                            macroTotals.calories += mealData.calories;
                            macroTotals.protein += mealData.protein;
                            macroTotals.carbs += mealData.carbs;
                            macroTotals.fat += mealData.fat;
                            updateMacroSummary();
                        } else {
                            alert('Failed to log meal: ' + (j.error || 'unknown'));
                        }
                    } catch (err) {
                        console.error(err);
                        alert('Failed to save estimated meal.');
                    }
                });
            }
        } else {
            resultDiv.innerHTML = `<span style="color:red;">${data.error || "Prediction failed."}</span>`;
        }
    } catch (err) {
        console.error(err);
        alert('Error communicating with server.');
    }
});